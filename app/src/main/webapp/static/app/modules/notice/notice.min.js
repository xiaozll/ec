var noticeId=noticeId;var hasRepeatPermission=hasRepeatPermission;var isSuperUser=isSuperUser;var $notice_datagrid;var $notice_dialog;var $notice_form;var $form_noticeUser_MultiSelect;var $notice_search_form;var read_linkbutton_text="我的通知";var $query_PublishUser_MultiSelect;var _operateType=undefined;$(function(){if(isSuperUser){$("#publishUserIds_tr").show();$("#layout_north").panel("resize",{height:138});$.parser.parse($(".easyui-layout").parent())}$notice_search_form=$("#notice_search_form").form();initReadDatagrid();initSelectUser();if(noticeId!=""){view(noticeId,hasRepeatPermission)}mymessage()});function refreshMessage(){mymessage();try{parent.refreshPortal()}catch(a){}}function mymessage(){$.ajax({url:ctxAdmin+"/notice/myMessage",type:"get",dataType:"json",success:function(a){if(a.code==1){var b=a.obj;if(b.noticeScopes>0){var c=read_linkbutton_text+"&nbsp;<span style='color: red;'>（"+b.noticeScopes+"）</span>";$("#read_linkbutton").linkbutton({text:c})}else{$("#read_linkbutton").linkbutton({text:read_linkbutton_text})}}}})}function initReadDatagrid(){$notice_datagrid=$("#notice_datagrid").datagrid({url:ctxAdmin+"/notice/readDatagrid",fit:true,pagination:true,rownumbers:true,fitColumns:false,striped:true,pageSize:20,checkOnSelect:false,selectOnCheck:false,idField:"id",frozenColumns:[[{field:"ck",checkbox:true},{field:"title",title:"标题",width:360,formatter:function(b,a,c){return"<a href='#' onclick='view(\""+a.noticeId+'",'+hasRepeatPermission+")' >"+b+"</a>"}}]],columns:[[{field:"id",title:"主键",hidden:true,sortable:true,align:"right",width:80},{field:"publishUserName",title:"发布人",width:100},{field:"publishTime",title:"发布时间",sortable:true,width:146},{field:"isReadView",title:"通知状态",sortable:true,width:100}]],toolbar:[{text:"标记为已读",iconCls:"eu-icon-mail_mark_read",handler:function(){markReaded()}}],onLoadSuccess:function(){$(this).datagrid("clearSelections");$(this).datagrid("clearChecked");$(this).datagrid("unselectAll");$(this).datagrid("uncheckAll")}}).datagrid("showTooltip")}function initDatagrid(){$notice_datagrid=$("#notice_datagrid").datagrid({url:ctxAdmin+"/notice/datagrid",fit:true,pagination:true,fitColumns:false,striped:true,pageSize:20,singleSelect:false,checkOnSelect:true,selectOnCheck:true,rownumbers:true,checkbox:true,nowrap:true,border:false,idField:"id",frozenColumns:[[{field:"ck",checkbox:true},{field:"title",title:"标题",width:360,formatter:function(b,a,c){return"<a href='#' onclick='view(\""+a.id+'",'+hasRepeatPermission+")' >"+b+"</a>"}}]],columns:[[{field:"id",title:"主键",hidden:true,sortable:true,width:80},{field:"typeView",title:"类型",width:80},{field:"publishUserName",title:"发布人",width:80},{field:"publishTime",title:"发布时间",width:146,sortable:true},{field:"effectTime",title:"生效时间",width:136,sortable:true},{field:"invalidTime",title:"终止时间",width:136,sortable:true},{field:"modeView",title:"状态",width:80},{field:"operate",title:"操作",width:150,formatter:function(d,c,e){var b="";var a="<a class='easyui-linkbutton' data-options='iconCls:\"easyui-icon-edit\"' onclick='edit(\""+c.id+"\");' >编辑</a>";if(c.mode==0){b=a+"&nbsp;<a class='easyui-linkbutton' data-options='iconCls:\"eu-icon-mail_forward\"' onclick='publish(\""+c.id+"\");' >发布 </a>"}else{if(c.mode==1){b+="&nbsp;<a class='easyui-linkbutton' data-options='iconCls:\"eu-icon-notice_stop\"' onclick='invalid(\""+c.id+"\");' >终止</a>"}}if(c.isRecordRead==1&&c.mode!=0&&c.mode!=3){b+="&nbsp;<a class='easyui-linkbutton' data-options='iconCls:\"eu-icon-mail_find\"'  onclick='readInfo(\""+c.id+"\");' >查看阅读情况</a>"}return b}}]],toolbar:[{text:"新增",iconCls:"easyui-icon-add",handler:function(){edit()}},"-",{text:"删除",iconCls:"easyui-icon-remove",handler:function(){del()}},"-",{text:"我的联系人",iconCls:"eu-icon-user",handler:function(){eu.addTab(window.parent.layout_center_tabs,"我的联系人",ctxAdmin+"/mail/contactGroup",true,"eu-icon-user","",false)}}],onRowContextMenu:function(b,c,a){b.preventDefault();$(this).datagrid("unselectAll");$(this).datagrid("selectRow",c)},onLoadSuccess:function(){$(this).datagrid("clearSelections");$(this).datagrid("clearChecked");$(this).datagrid("unselectAll");$(this).datagrid("uncheckAll")}}).datagrid("showTooltip")}function view(c,f){var i=ctxAdmin+"/notice/view/"+c;var g=new Array();var h={text:"关闭",iconCls:"easyui-icon-cancel",handler:function(){a.dialog("destroy");$notice_datagrid.datagrid("reload");refreshMessage()}};if(f!=undefined&&f==true){var e={text:"转发",iconCls:"eu-icon-mail_reply_sender",handler:function(){a.dialog("destroy");edit(c,"Repeat")}};g.push(e)}g.push(h);var b=document.body.clientHeight-50;var d=document.body.clientWidth*0.9-50;var a=$("<div/>").dialog({title:"查看通知",width:d,height:b,modal:true,maximizable:true,content:'<iframe id="notice_view_iframe" scrolling="no" frameborder="0"  src="'+i+'" ></iframe>',buttons:g,onClose:function(){a.dialog("destroy");$notice_datagrid.datagrid("reload");refreshMessage()}})}function readInfo(a){var c=ctxAdmin+"/notice/readInfo/"+a;var b=$("<div/>").dialog({title:"查看状态",width:600,height:400,modal:true,maximizable:true,href:c,buttons:[{text:"关闭",iconCls:"easyui-icon-cancel",handler:function(){b.dialog("destroy")}}],onClose:function(){b.dialog("destroy")}})}function formInit(){$notice_form=$("#notice_form").form({url:ctxAdmin+"/notice/save",onSubmit:function(d){$.messager.progress({title:"提示信息！",text:"数据处理中，请稍后...."});var c=$(this).form("validate");if(!c){$.messager.progress("close")}else{var b=$("#_effectTime").my97("getValue");var a=$("#_endTime").my97("getValue");if(a!=undefined&&a!=""&&b>a){eu.showAlertMsg("后者所填时间必须大于前者时间","warning");c=false}d.operateType=_operateType}return c},success:function(b){$.messager.progress("close");var a=$.parseJSON(b);if(a.code==1){$notice_dialog.dialog("destroy");$notice_datagrid.datagrid("reload");eu.showMsg(a.msg)}else{if(a.code==2){$.messager.alert("提示信息！",a.msg,"warning",function(){if(a.obj){$('#$notice_form input[title="'+a.obj+'"]').focus()}})}else{eu.showAlertMsg(a.msg,"error")}}}})}function edit(a,b){var c=ctxAdmin+"/notice/input?operateType=";if(b!=undefined){c+=b}if(a!=undefined){c+="&id="+a}$notice_dialog=$("<div/>").dialog({title:"通知信息",width:document.body.clientWidth,height:document.body.clientHeight,modal:true,maximizable:true,href:c,buttons:[{text:"保存",iconCls:"easyui-icon-save",handler:function(){_operateType="Save";$notice_form.submit()}},{text:"发布",iconCls:"eu-icon-mail_forward",handler:function(){_operateType="Publish";$notice_form.submit()}},{text:"关闭",iconCls:"easyui-icon-cancel",handler:function(){$notice_dialog.dialog("destroy")}}],onClose:function(){$(this).dialog("destroy")},onLoad:function(){formInit()}})}function publish(a){$.post(ctxAdmin+"/notice/publish/"+a,{},function(c){var b=$.parseJSON(c);if(b.code==1){$notice_datagrid.datagrid("reload");eu.showMsg(b.msg)}else{eu.showAlertMsg(b.msg,"error")}})}function invalid(a){$.post(ctxAdmin+"/notice/invalid/"+a,{},function(c){var b=$.parseJSON(c);if(b.code==1){$notice_datagrid.datagrid("reload");eu.showMsg(b.msg)}else{eu.showAlertMsg(b.msg,"error")}})}function markReaded(d){var b=new Array();var c="您确定要删除选中的所有通知标记为已读？";if(d!=undefined){$notice_datagrid.datagrid("unselectAll");$notice_datagrid.datagrid("selectRow",d);var a=$notice_datagrid.datagrid("getSelected");b.push(a);$notice_datagrid.datagrid("unselectRow",d);c="您确定要将通知["+a.title+"]标记为已读？"}else{b=$notice_datagrid.datagrid("getChecked")}if(b.length>0){$.messager.confirm("确认提示！","您确定要标记所有行为已读？",function(f){if(f){var e=new Array();$.each(b,function(g,h){e[g]=h.noticeId});$.ajax({url:ctxAdmin+"/notice/markReaded",type:"post",data:{ids:e},dataType:"json",traditional:true,success:function(g){if(g.code==1){$notice_datagrid.datagrid("reload");eu.showMsg(json.msg);refreshMessage()}else{eu.showAlertMsg(g.msg,"error")}}})}})}else{eu.showMsg("请选择要操作的对象！")}}function del(){var a=$notice_datagrid.datagrid("getChecked");if(a.length>0){$.messager.confirm("确认提示！","您确定要删除选中的所有行?",function(c){if(c){var b=new Array();$.each(a,function(d,e){b[d]=e.id});$.ajax({url:ctxAdmin+"/notice/remove",type:"post",data:{ids:b},dataType:"json",traditional:true,success:function(d){if(d.code==1){$notice_datagrid.datagrid("load");eu.showMsg(d.msg)}else{eu.showAlertMsg(d.msg,"error")}}})}})}else{eu.showMsg("请选择要操作的对象！")}}function convertValues(a){var c="";if(a!=undefined){c=a.input.val()}var b={};b.query=c;return b}function initSelectUser(){$query_PublishUser_MultiSelect=$("#publishUserIds").kendoMultiSelect({dataTextField:"name",dataValueField:"id",dataSource:{transport:{read:{url:ctxAdmin+"/sys/user/customUserList",dataType:"json"},parameterMap:function(b,a){if(a=="read"){return convertValues($query_PublishUser_MultiSelect)}}},serverFiltering:true,group:{field:"defaultOrganName"}}}).data("kendoMultiSelect")}function selectQueryUser(){var d="";var b=$query_PublishUser_MultiSelect.dataItems();if(b&&b.length>0){var a=b.length;$.each(b,function(f,e){if(f==a-1){d+=e.id}else{d+=e.id+","}})}var c=$("<div/>").dialog({title:"选择用户",top:10,href:ctxAdmin+"/sys/user/organUserTreePage?checkedUserIds="+d,width:"500",height:"360",maximizable:true,iconCls:"easyui-icon-user",modal:true,buttons:[{text:"确定",iconCls:"easyui-icon-save",handler:function(){setQuerySelectUser();c.dialog("destroy")}},{text:"关闭",iconCls:"easyui-icon-cancel",handler:function(){c.dialog("destroy")}}],onClose:function(){c.dialog("destroy")}})}function setQuerySelectUser(){var b=new Array();var a=$("#organUserTree").tree("getChecked");$.each(a,function(c,d){if("u"==d.attributes.nType){b.push(d.id)}});$query_PublishUser_MultiSelect.value(b)}function search(){$notice_datagrid.datagrid("load",$.serializeObject($notice_search_form))};