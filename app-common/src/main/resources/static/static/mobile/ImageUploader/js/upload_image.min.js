function Wrapper(b){var a=document.body.scrollHeight>window.screen.availHeight?document.body.scrollHeight+"px":window.screen.availHeight+"px";this.config=$.extend({},{zIndex:100,opacity:0.5,width:"100%",height:a,top:0,background:"#000"},b||{}),this.$wrapper=$("#J_wrapper").length>0?$("#J_wrapper"):function(){return $("body").append($('<div id="J_wrapper"></div>')),$("#J_wrapper")}(),$.extend(Wrapper.prototype,{show:function(d){var c=this;return $("body").css("overflow","hidden"),c.$wrapper.css({position:"absolute",opacity:c.config.opacity,background:c.config.background,zIndex:c.config.zIndex,top:c.config.top,width:c.config.width,height:c.config.height}),$.isFunction(d)&&d.call(c),c.$wrapper},close:function(){this.$wrapper.remove(),$("body").css("overflow","auto")}})}function ImageUploader(c,k){var h=function(m,l){var o=this;o.config=$.extend({},{inputName:"img",onlyShow:!1,uploadBtn:".J_UploadBtn",fileInput:".J_FileInput",prevClass:"preview",quality:0.8,qualityIOS:0,maxWidth:0,maxHeight:0,uploaderUrl:"",deleteImage:true,deleteUrl:"",limitSize:5,limitNum:1,beforeComplete:function(n){},afterComplete:function(){},afterDeleteImageComplete:function(){}},l),o.file=null,o.$controller=m,o.$uploadBtn=m.find(o.config.uploadBtn);o.$fileInput=m.find(o.config.fileInput);o.$uploadBtn.css({overflow:"hidden"});o.$uploadBtn.on("click",function(){o.$fileInput.focus()});$(".upload-area").on("click","img",function(){d(o,this.dataset.url,"img_"+this.dataset.fileid,this.dataset.fileid,o.config.deleteImage)});return o.uploadImage()};$.extend(h.prototype,{compressImage:function(p,o){var n=this;if(!p){return}o=o||function(){};var m=document.createElement("canvas");var l=new Image();l.onload=function(){var r=m.getContext("2d");r.clearRect(0,0,m.width,m.height);var t=n.config.maxWidth||l.width;var s=n.config.maxHeight||l.height;if(l.width>t||l.height>s){var q=Math.max(l.width/t,l.height/s);m.width=l.width/q;m.height=l.height/q}else{m.width=l.width;m.height=l.height}r.drawImage(l,0,0,l.width,l.height,0,0,m.width,m.height);o(m.toDataURL("image/jpeg",n.config.quality||1))};l.src=p},uploadImage:function(){var m=this;function l(n){if(n.length/1024/1400>=m.config.limitSize){m.$fileInput.val("");alert("上传文件太大");return}var o=$("<img>"),q=(new Date).getTime();var p="";m.$uploadBtn.addClass("loading");$.ajax({type:"post",url:m.config.uploaderUrl,data:{base64Data:n},dataType:"json",cache:!1,success:function(t){var s=t.obj["url"];var r=t.obj["id"];o[0].onload=function(){var v="img_"+r;var u=$("img.preview").length;m.$uploadBtn.before(o.addClass("small").addClass(m.config.prevClass).addClass(v));m.$uploadBtn.before('<input type="hidden" name="'+m.config.inputName+'" data-index="'+u+'" class="'+v+'" value="'+r+'">');o.attr("data-url",s);o.attr("data-fileid",r);o.on("click",function(){d(m,this.dataset.url,v,t.obj["id"],m.config.deleteImage)});m.$uploadBtn.removeClass("loading");m.config.afterComplete.call(m)};o[0].src=s},error:function(){},complete:function(){}})}m.$fileInput.on("change",function(q){if(m.$uploadBtn.siblings("."+m.config.prevClass).length>=m.config.limitNum){m.$fileInput.val("");alert("最多可上传: "+i.config.limitNum+"张");return}var r=m.file=q.target.files[0];var p=m.config.beforeComplete.call(m,r);if(p!=undefined&&p==false){return}if(m.file){var o=new FileReader;o.onloadend=function(n){if(b()){g(m,n.target.result,l)}else{m.compressImage(n.target.result,l)}};o.readAsDataURL(m.file)}})}});function j(p,n){var q=n,o=$("<canvas/>")[0],l=o.getContext("2d"),m=new Image();p.addClass("g-img-loading");m.onload=function(){var s=m.width,r=m.height,u=320,t=window.screen.availWidth;if(s>t){o.width=t;o.height=r*(t/s)}else{o.width=s;o.height=r}l.drawImage(m,0,0,o.width,o.height);p.append(o)};$(m).one("load",function(){p.removeClass("g-img-loading")});m.src=q}function d(n,r,t,o,u){var m=new Wrapper({zIndex:200,overflow:"hidden",opacity:0.8});var s=$("#J_ImageSlider").length>0?$("#J_ImageSlider"):function(){return $("body").append($('<div id="J_ImageSlider"></div>')),$("#J_ImageSlider")}();s.html("");var p=$('<div class="'+t+'"/>');p.css({paddingTop:"5%",height:"90%",width:"100%",textAlign:"center",position:"absolute",top:"0px",left:"0px",zIndex:"600"});j(p,r);var q="<p>";if(u){q+='<a href="#" class="J_Image_Del" data-fileId="'+o+'" data-cname="'+t+'">删除</a>'}q+='<a href="#" class="J_Slider_Close" data-cname="'+t+'">关闭</a>';q+="</p>";if(this.n){}p.append(q);p.find("p").css({position:"absolute",bottom:0,width:"100%"}).find("a").css({color:"#ccc",display:"inline-block",width:"35%",boxShadow:"0 0 5px #000",border:"1px solid #444",padding:"5px 0",background:"#000"});p.css({width:"100%",textAlign:"center"});s.append(p);m.show(function(){$(".J_Slider_Close").on("click",function(l){s.remove();m.close();l.preventDefault()});$(".J_Image_Del").on("click",function(){var l=$(this).data("cname");$("."+l).remove();s.remove();m.close();n.config.afterDeleteImageComplete.call(n);e.preventDefault()})})}function f(o){var l=o.split(","),q=l[0].match(/:(.*?);/)[1],m=atob(l[1]),r=m.length,p=new Uint8Array(r);while(r--){p[r]=m.charCodeAt(r)}return new Blob([p],{type:q})}function b(){var l=navigator.userAgent;return l.match(/(iPad).*OS\s([\d_]+)/)||l.match(/(iPod)(.*OS\s([\d_]+))?/)||l.match(/(iPhone\sOS)\s([\d_]+)/)}function a(q,r,n){var l=0;var s=3;if(q==null){return}var t=q.height;var m=q.width;var o=2;if(o==null){o=l}if(r=="right"){o++;o>s&&(o=l)}else{o--;o<l&&(o=s)}var p=o*90*Math.PI/180;var u=n.getContext("2d");switch(o){case 0:n.width=m;n.height=t;u.drawImage(q,0,0);break;case 1:n.width=t;n.height=m;u.rotate(p);u.drawImage(q,0,-t);break;case 2:n.width=m;n.height=t;u.rotate(p);u.drawImage(q,-m,-t);break;case 3:n.width=t;n.height=m;u.rotate(p);u.drawImage(q,-m,0);break}}function g(n,l,m){var o=new Image();base64=null;o.src=l;o.onload=function(){var t="";EXIF.getData(this,function(){t=EXIF.getTag(this,"Orientation")});var q=this.naturalWidth;var s=this.naturalHeight;var r=document.createElement("canvas");var p=r.getContext("2d");r.width=q;r.height=s;p.drawImage(this,0,0,q,s);if(t!=""&&t!=1){switch(t){case 6:a(this,"left",r);break;case 8:a(this,"right",r);break;case 3:a(this,"right",r);a(this,"right",r);break}}base64=r.toDataURL("image/jpeg",n.config.qualityIOS||n.config.quality||1);m(base64)}}return new h(c,k)};