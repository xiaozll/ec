var $folder_tree;var contextMenuNode;var $folder_form;var $folder_dialog;var $folder_file_search_form;var $folder_file_datagrid;var defaultSelectedNode=null;var editRow=undefined;var editRowData=undefined;var isAdmin=isAdmin;var folder_file_toolbar={text:"上传文件",iconCls:"eu-icon-upload",handler:function(){addFolderFile()}};$(function(){$folder_file_search_form=$("#folder_file_search_form").form();loadDiskTree();loadFileDatagrid()});function loadFileDatagrid(){$folder_file_datagrid=$("#folder_file_datagrid").datagrid({url:"",checkOnSelect:false,selectOnCheck:false,fit:true,fitColumns:false,striped:true,remoteSort:false,idField:"id",frozen:true,collapsible:true,showFooter:true,pagination:true,rownumbers:true,pageSize:20,pageList:[10,20,50,500,9999],frozenColumns:[[{field:"ck",checkbox:true},{field:"name",title:"文件名",sortable:true,width:360,formatter:function(b,a,c){if(b!=="总大小"){return"<a onclick='downloadFile(\""+a.fileId+"\")'>"+b+"</a>"}else{return b}},editor:{type:"validatebox",options:{required:true,missingMessage:"请输入名称！",validType:["minLength[1]","length[1,200]"]}}}]],columns:[[{field:"id",title:"主键",hidden:true,sortable:true,align:"right",width:80},{field:"prettyFileSize",title:"文件大小",sortable:true,align:"right",width:110},{field:"userName",title:"上传人",width:100},{field:"updateTime",title:"更新时间",sortable:true,width:200},{field:"operate",title:"操作",formatter:function(e,d,f){var b="";if(d.id){if(d.editing){b="<a class='easyui-linkbutton' data-options='iconCls:\"easyui-icon-save\"' onclick='saveFileName(this,"+f+',"'+d.id+"\")' >保存 </a>";b+="&nbsp;<a class='easyui-linkbutton' data-options='iconCls:\"easyui-icon-cancel\"' onclick='rejectChanges("+f+");' >取消  </a>"}else{b="<a class='easyui-linkbutton' data-options='iconCls:\"eu-icon-disk_download\"' onclick='downloadFile(\""+d.fileId+"\")'>下载</a>";var a="&nbsp;<a class='easyui-linkbutton' data-options='iconCls:\"easyui-icon-edit\"' onclick='beginEdit("+f+")'>更名</a>";var c="&nbsp;<a class='easyui-linkbutton' data-options='iconCls:\"easyui-icon-remove\"' onclick='delFolderFile(\""+d.id+'","'+d.name+"\")'>删除</a>&nbsp";b+=a;b+=c}}return b}}]],onBeforeEdit:function(a,b){editRow=a;editRowData=b;b.editing=true;updateActions(a);$.parser.parse($(".easyui-linkbutton").parent())},onAfterEdit:function(a,b){b.editing=false;updateActions(a);$.parser.parse($(".easyui-linkbutton").parent());editRow=undefined},onCancelEdit:function(a,b){b.editing=false;updateActions(a);$.parser.parse($(".easyui-linkbutton").parent());editRow=undefined},onLoadSuccess:function(){$(this).datagrid("clearSelections");$(this).datagrid("clearChecked");$(this).datagrid("unselectAll");editRow=undefined},onHeaderContextMenu:function(b,a){b.preventDefault()}}).datagrid("showTooltip")}function loadDiskTree(){$folder_tree=$("#folder_tree").tree({url:ctxAdmin+"/disk/diskTree",formatter:function(a){return a.text},onClick:function(a){},onBeforeSelect:function(a){defaultSelectedNode=a;return true},onBeforeLoad:function(a,b){$("#folder_tree").html("数据加载中...")},onSelect:function(e){if($folder_file_datagrid){var c=e.attributes.nType;var b=e.attributes.folderAuthorize;var d=[{text:"批量下载",iconCls:"eu-icon-disk_download",handler:function(){downloadFile()}}];var a={};if("FolderAuthorize"===c){if("0"==e.id||("1"==e.id&&"1"===b&&isAdmin)){d.unshift(folder_file_toolbar)}}else{if("Folder"===c){if(("0"===b||("1"===b&&isAdmin))){d.unshift(folder_file_toolbar)}}}if("Folder"===c){a={folderId:e.id}}else{if("FolderAuthorize"===c){a={folderAuthorize:e.id}}}$folder_file_datagrid.datagrid({toolbar:d,queryParams:a,url:ctxAdmin+"/disk/folderFileDatagrid"}).datagrid("showTooltip")}},onContextMenu:function(d,c){d.preventDefault();contextMenuNode=c;var a=c.attributes.nType;var b="folder_treeMenu_add";if("Folder"===a){if(true===c.attributes.operate){b="folder_treeMenu_all"}else{b=""}}if(""!==b){$("#"+b).menu({onClick:function(e){if("addFolder"===e.name){showFolderDialog()}else{if("editFolder"===e.name){showFolderDialog(c.id)}else{if("deleteFolder"===e.name){delFolder(c.id,c.text)}}}}}).menu("show",{left:d.pageX,top:d.pageY})}},onLoadSuccess:function(b,c){contextMenuNode=undefined;if(defaultSelectedNode!=null){defaultSelectedNode=$(this).tree("find",defaultSelectedNode.id);if(defaultSelectedNode!=null){$(this).tree("select",defaultSelectedNode.target)}}$(this).tree("expandAll");var a=$(this).tree("getRoots");if(defaultSelectedNode==null){$folder_tree.tree("select",a[0].target)}}})}function saveFileName(e,b,f){$folder_file_datagrid.datagrid("unselectAll");$folder_file_datagrid.datagrid("selectRow",b);$folder_file_datagrid.datagrid("endEdit",b);var a=$folder_file_datagrid.datagrid("getSelected");var d=$folder_file_datagrid.datagrid("validateRow",b);if(!d){var c=$folder_file_datagrid.datagrid("getEditor",{index:b,field:"name"});$(c.target).focus();return false}$.ajax({type:"post",url:ctxAdmin+"/disk/fileSave",data:$.extend({id:a.id,modelType:"File"},a),traditional:true,dataType:"json",success:function(g){if(g.code===1){$folder_file_datagrid.datagrid("reload");eu.showMsg(g.msg)}}})}function updateActions(a){$folder_file_datagrid.datagrid("updateRow",{index:a,row:{}});$folder_file_datagrid.datagrid("refreshRow",a)}function beginEdit(a){$folder_file_datagrid.datagrid("beginEdit",a)}function rejectChanges(a){$folder_file_datagrid.datagrid("endEdit",a);$folder_file_datagrid.datagrid("rejectChanges",a)}function downloadFile(a){var c=[];if(a){c.push(a)}else{var d=$folder_file_datagrid.datagrid("getChecked");if(d){$.each(d,function(e,f){c.push(f.fileId)})}}if(c.length>0){var b=ctxAdmin+"/disk/downloadDiskFile?fileIds="+c.join(",");$("#annexFrame").attr("src",b)}else{eu.showMsg("请选择要操作的对象！")}}function showFolderDialog(a){var i=ctxAdmin+"/disk/folderInput";if(a!==undefined){i+="?folderId="+a}else{var f=$folder_tree.tree("getSelected");f=(contextMenuNode!==undefined)?contextMenuNode:f;if(f!==undefined&&f!=null){var g="";var d=f.attributes.nType;var b=f.id;var c="";if("FolderAuthorize"===d&&("0"===b||"1"===b)){g=b}else{if("Folder"===d){c=b;var e=$folder_tree.tree("getParent",f.target);var h=$folder_tree.tree("getLevel",f.target);while(e!==undefined&&h!==2){h=$folder_tree.tree("getLevel",e.target);e=$folder_tree.tree("getParent",e.target)}if(e!==undefined){g=e.id}}}i+="?folderAuthorize="+g+"&parentFolderId="+c}}$folder_dialog=$("<div/>").dialog({title:"文件夹信息",top:20,width:500,height:360,modal:true,maximizable:true,href:i,buttons:[{text:"保存",iconCls:"easyui-icon-save",handler:function(){$folder_form.submit()}},{text:"关闭",iconCls:"easyui-icon-cancel",handler:function(){$folder_dialog.dialog("destroy")}}],onClose:function(){$(this).dialog("destroy")},onLoad:function(){folderFormInit()}})}function folderFormInit(){$folder_form=$("#folder_form").form({url:ctxAdmin+"/disk/saveFolder",onSubmit:function(b){$.messager.progress({title:"提示信息！",text:"数据处理中，请稍后...."});var a=$(this).form("validate");if(!a){$.messager.progress("close")}else{b.modelType="Folder"}return a},success:function(b){$.messager.progress("close");var a=$.parseJSON(b);if(a.code===1){$folder_dialog.dialog("destroy");$folder_tree.tree("reload");eu.showMsg(a.msg)}else{if(a.code===2){$.messager.alert("提示信息！",a.msg,"warning",function(){if(a.obj){$('#$folder_form input[name="'+a.obj+'"]').focus()}})}else{eu.showAlertMsg(a.msg,"error")}}}})}function delFolder(a,b){$.messager.confirm("确认提示！","您确定要删除["+b+"],包含下级文件夹以及文件?",function(c){if(c){$.messager.progress({title:"提示信息！",text:"数据处理中，请稍后...."});$.ajax({url:ctxAdmin+"/disk/folderRemove/"+a,type:"post",dataType:"json",traditional:true,success:function(d){$.messager.progress("close");if(d.code===1){$folder_tree.tree("reload");$folder_file_datagrid.datagrid("reload");eu.showMsg(d.msg)}else{eu.showAlertMsg(d.msg,"error")}}})}})}function addFolderFile(){var b=$folder_tree.tree("getSelected");if(b!==undefined&&b.id!==undefined){var d=b.text;var c="上传文件";if(d!==undefined&&d!==null&&d!==""){c+=":"+d}var a=ctxAdmin+"/disk/fileInput?folderId="+b.id;_dialog=$("<div/>").dialog({title:c,top:10,href:a,width:500,height:360,maximizable:true,iconCls:"eu-icon-file",modal:true,buttons:[{text:"关闭",iconCls:"easyui-icon-cancel",handler:function(){_dialog.dialog("destroy");$folder_file_datagrid.datagrid("reload")}}],onClose:function(){_dialog.dialog("destroy")}})}}function delFolderFile(a,d){var b=$folder_file_datagrid.datagrid("getChecked");if(a!==undefined||b.length>0){var c="您确定要删除";if(d!==undefined){c+="文件["+d+"]?"}else{c+="选中的所有文件?"}$.messager.confirm("确认提示！",c,function(e){if(e){var f=[];$.messager.progress({title:"提示信息！",text:"数据处理中，请稍后...."});if(a!==undefined){f.push(a)}else{$.each(b,function(g,h){f.push(h.id)})}$.ajax({url:ctxAdmin+"/disk/delFolderFile",type:"post",data:{fileIds:f},dataType:"json",traditional:true,success:function(g){$.messager.progress("close");if(g.code===1){$folder_file_datagrid.datagrid("reload");eu.showMsg(g.msg)}else{eu.showAlertMsg(g.msg,"error")}}})}})}else{eu.showMsg("请选择要操作的对象！")}}function search(){var c=$folder_tree.tree("getSelected");var a="";if(c){a=c.id}var b=$.extend($.serializeObject($folder_file_search_form),{folderId:a});$folder_file_datagrid.datagrid("load",b)};