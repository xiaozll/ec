var sessionInfoUserId=sessionInfoUserId;var hasPermissionUserAdd=hasPermissionUserAdd;var hasPermissionUserDelete=hasPermissionUserDelete;function isSuperUser(){return sessionInfoUserId==="1"}function isSuperOwner(a){return a==="1"}function isOpeated(a){return !(a==="1"&&!isSuperUser())}var $organ_tree;var $user_datagrid;var $user_form;var $user_password_form;var $user_role_form;var $user_resource_form;var $user_organ_form;var $user_search_form;var $user_dialog;var $user_password_dialog;var $user_role_dialog;var $user_resource_dialog;var $user_organ_dialog;var $user_post_form;var $user_post_dialog;$(function(){$user_search_form=$("#user_search_form").form();var c=null;$organ_tree=$("#organ_tree").tree({url:ctxAdmin+"/sys/organ/tree?dataScope=2&cascade=true",onClick:function(d){search()},onBeforeSelect:function(d){c=d;return true},onBeforeLoad:function(d,e){if(d){e.parentId=d.id}},onLoadSuccess:function(e,f){if(c!=null){c=$(this).tree("find",c.id);if(c!=null){$(this).tree("select",c.target)}}var d=$(this).tree("getRoot");if(d){$(this).tree("expand",d.target)}}});var b=[];if(hasPermissionUserAdd){b=b.concat([{text:"新增",iconCls:"easyui-icon-add",handler:function(){showDialog()}},"-"])}b=b.concat([{text:"编辑",iconCls:"easyui-icon-edit",handler:function(){edit()}},"-"]);if(hasPermissionUserDelete){b=b.concat([{text:"删除",iconCls:"easyui-icon-remove",handler:function(){del()}},"-"])}b=b.concat([{text:"修改密码",iconCls:"eu-icon-lock",handler:function(){editPassword()}},"-",{text:"设置机构",iconCls:"eu-icon-group",handler:function(){editUserOrgan()}},"-",{text:"设置岗位",iconCls:"eu-icon-user",handler:function(){editUserPost()}},"-",{text:"设置角色",iconCls:"eu-icon-group",handler:function(){editUserRole()}},"-",{text:"设置资源",iconCls:"eu-icon-folder",handler:function(){editUserResource()}},"-",{text:"查看权限",iconCls:"easyui-icon-search",handler:function(){viewUserResources()}},"-",{text:"上移",iconCls:"eu-icon-up",handler:function(){move(true)}},"-",{text:"下移",iconCls:"eu-icon-down",handler:function(){move()}},"-",{text:"启用",iconCls:"eu-icon-user",handler:function(){lock(false)}},"-",{text:"停用",iconCls:"eu-icon-lock",handler:function(){lock(true)}}]);$user_datagrid=$("#user_datagrid").datagrid({url:ctxAdmin+"/sys/user/datagrid",fit:true,pagination:true,rownumbers:true,fitColumns:false,striped:true,pageSize:20,pageList:[10,20,50,100,1000,99999],remoteSort:false,idField:"id",frozen:true,collapsible:true,frozenColumns:[[{field:"ck",checkbox:true},{field:"loginName",title:"登录名",width:120,sortable:true,formatter:function(e,d,f){if(isSuperOwner(d.id)){return $.formatString('<span  style="color:red">{0}</span>',e)}return e}},{field:"name",title:"姓名",width:100,sortable:true,formatter:function(f,e,g){var d="<a href='#'  onclick='edit("+g+");' >"+f+"</a>";return d}}]],columns:[[{field:"code",title:"员工编号",width:80,hidden:true,sortable:true},{field:"id",title:"主键",hidden:true,sortable:true,align:"right",width:80},{field:"tel",title:"办公电话",width:100},{field:"mobile",title:"手机号",width:100},{field:"qq",title:"QQ",width:100},{field:"email",title:"公司邮箱",width:160},{field:"personEmail",title:"个人邮箱",width:160},{field:"defaultOrganId",title:"默认机构ID",width:80,hidden:true},{field:"defaultOrganName",title:"部门",width:160,sortable:true},{field:"companyName",title:"单位",width:200,sortable:true,hidden:true},{field:"sexView",title:"性别",width:60,align:"center",sortable:true},{field:"birthday",title:"出生日期",width:80,sortable:true},{field:"address",title:"地址",width:200},{field:"remark",title:"备注",width:200},{field:"sort",title:"排序",width:60,sortable:true},{field:"statusView",title:"状态",align:"center",width:60,formatter:function(e,d,f){if(d.status!==0){return $.formatString('<span  style="color:red">{0}</span>',e)}return e}},{field:"operater",title:"操作",width:260,formatter:function(f,e,g){var d="<a class='easyui-linkbutton' iconCls='easyui-icon-edit'  href='#' onclick='edit("+g+");' >编辑</a>";d+="&nbsp;<a class='easyui-linkbutton' iconCls='easyui-icon-search'  href='#' onclick='viewUserResources("+g+");' >查看权限</a>";if(isSuperUser()){d+="&nbsp;<a class='easyui-linkbutton' iconCls='easyui-icon-search'  href='#' onclick='viewUserPassword(\""+e.loginName+"\");' >密码</a>"}return d}}]],toolbar:b,onLoadSuccess:function(){$(this).datagrid("clearSelections");$(this).datagrid("unselectAll")},onRowContextMenu:function(f,g,d){f.preventDefault();$(this).datagrid("unselectAll");$(this).datagrid("selectRow",g);$("#user_datagrid_menu").menu("show",{left:f.pageX,top:f.pageY})},onDblClickRow:function(e,d){edit(e,d)}}).datagrid("showTooltip");$query=$("#query").autocomplete(ctxAdmin+"/sys/user/autoComplete",{remoteDataType:"json",minChars:0,maxItemsToShow:10});var a=$query.data("autocompleter");a.setExtraParam("rows",a.options.maxItemsToShow)});function viewUserPassword(a){$.ajax({url:ctxAdmin+"/sys/user/viewUserPassword",type:"post",data:{loginName:a},traditional:true,dataType:"json",success:function(b){if(b.code===1){eu.showTopCenterMsg(b.obj)}else{eu.showAlertMsg(b.msg,"error")}}})}function formInit(){$user_form=$("#user_form").form({url:ctxAdmin+"/sys/user/save",onSubmit:function(b){$.messager.progress({title:"提示信息！",text:"数据处理中，请稍后...."});var a=$(this).form("validate");if(!a){$.messager.progress("close")}return a},success:function(b){$.messager.progress("close");var a=$.parseJSON(b);if(a.code===1){$user_dialog.dialog("destroy");$user_datagrid.datagrid("reload");$organ_tree.tree("reload");eu.showMsg(a.msg)}else{if(a.code===2){$.messager.alert("提示信息！",a.msg,"warning",function(){if(a.obj){$('#user_form input[name="'+a.obj+'"]').focus()}})}else{eu.showAlertMsg(a.msg,"error")}}}})}function showDialog(d){var c=ctxAdmin+"/sys/user/input";if(d!==undefined&&d.id){c+="?id="+d.id}else{var b=$organ_tree.tree("getSelected");var a="";if(b!=null){c+="?defaultOrganId="+b.id}}$user_dialog=$("<div/>").dialog({title:"用户详细信息",top:20,width:500,height:360,modal:true,maximizable:true,href:c,buttons:[{text:"保存",iconCls:"easyui-icon-save",handler:function(){$user_form.submit()}},{text:"关闭",iconCls:"easyui-icon-cancel",handler:function(){$user_dialog.dialog("destroy")}}],onClose:function(){$user_dialog.dialog("destroy")},onLoad:function(){formInit()}})}function edit(d,b){if(d!==undefined){$user_datagrid.datagrid("unselectAll");$user_datagrid.datagrid("selectRow",d);var b=$user_datagrid.datagrid("getSelected");$user_datagrid.datagrid("unselectRow",d);showDialog(b);return}var a=$user_datagrid.datagrid("getSelections");var c=$user_datagrid.datagrid("getSelected");if(c){if(a.length>1){c=a[a.length-1];eu.showMsg("您选择了多个操作对象，默认操作最后一次被选中的记录！")}if(isOpeated(c.id)===false){eu.showMsg("超级管理员用户信息不允许被其他人修改！");return}showDialog(c)}else{eu.showMsg("您未选择任何操作对象，请选择一行数据！")}}function viewUserResources(f){if(f!==undefined){$user_datagrid.datagrid("unselectAll");$user_datagrid.datagrid("selectRow",f)}var d=$user_datagrid.datagrid("getSelected");if(!d||!d.id){eu.showMsg("您未选择任何操作对象，请选择一行数据！");return false}var a=ctxAdmin+"/sys/user/viewUserResources?userId="+d.id;var c="查看权限-"+d.name;try{parent.addTabs({id:"viewUserResources_"+d.id,title:c,close:true,url:a,urlType:""})}catch(b){eu.addTab(window.parent.layout_center_tabs,c,a,true,"")}}function initPasswordForm(){$user_password_form=$("#user_password_form").form({url:ctxAdmin+"/sys/user/_updateUserPassword",onSubmit:function(d){d.upateOperate="0";$.messager.progress({title:"提示信息！",text:"数据处理中，请稍后...."});var b=$(this).form("validate");if(!b){$.messager.progress("close")}else{var a=$user_datagrid.datagrid("getSelections");var c=[];$.each(a,function(e,f){c.push(f.id)});d.userIds=c}return b},success:function(b){$.messager.progress("close");var a=$.parseJSON(b);if(a.code===1){$user_password_dialog.dialog("destroy");$user_datagrid.datagrid("reload");$organ_tree.tree("reload");eu.showMsg(a.msg)}else{eu.showAlertMsg(a.msg,"error")}}})}function editPassword(){var a=$user_datagrid.datagrid("getSelections");var b=$user_datagrid.datagrid("getSelected");if(b){if(!isOpeated(b.id)){eu.showMsg("超级管理员用户信息不允许被其他人修改！");return}var c="";if(a.length===1){c=b.id}$user_password_dialog=$("<div/>").dialog({title:"修改用户密码",top:20,width:500,height:200,modal:true,maximizable:true,href:ctxAdmin+"/sys/user/password?id="+c,buttons:[{text:"保存",iconCls:"easyui-icon-save",handler:function(){$user_password_form.submit()}},{text:"关闭",iconCls:"easyui-icon-cancel",handler:function(){$user_password_dialog.dialog("destroy")}}],onClose:function(){$user_password_dialog.dialog("destroy")},onLoad:function(){initPasswordForm()}})}else{eu.showMsg("您未选择任何操作对象，请选择一行数据！")}}function initUserRoleForm(){$user_role_form=$("#user_role_form").form({url:ctxAdmin+"/sys/user/updateUserRole",onSubmit:function(d){$.messager.progress({title:"提示信息！",text:"数据处理中，请稍后...."});var b=$(this).form("validate");if(!b){$.messager.progress("close")}else{var a=$user_datagrid.datagrid("getSelections");var c=[];$.each(a,function(e,f){c.push(f.id)});d.userIds=c}return b},success:function(b){$.messager.progress("close");var a=$.parseJSON(b);if(a.code===1){$user_role_dialog.dialog("destroy");$user_datagrid.datagrid("reload");$organ_tree.tree("reload");eu.showMsg(a.msg)}else{eu.showAlertMsg(a.msg,"error")}}})}function editUserRole(){var a=$user_datagrid.datagrid("getSelections");var c=$user_datagrid.datagrid("getSelected");if(c){if(!isOpeated(c.id)){eu.showMsg("超级管理员用户信息不允许被其他人修改！");return}if(c.id===1){eu.showMsg("超级管理员无需设置角色！");return}var b=ctxAdmin+"/sys/user/role";if(c.id&&a.length===1){b=b+"?id="+c.id}$user_role_dialog=$("<div/>").dialog({title:"用户角色信息",top:20,width:500,height:360,modal:true,maximizable:true,href:b,buttons:[{text:"保存",iconCls:"easyui-icon-save",handler:function(){$user_role_form.submit()}},{text:"关闭",iconCls:"easyui-icon-cancel",handler:function(){$user_role_dialog.dialog("destroy")}}],onClose:function(){$(this).dialog("destroy")},onLoad:function(){initUserRoleForm()}})}else{eu.showMsg("您未选择任何操作对象，请选择一行数据！")}}function initUserResourceForm(){$user_resource_form=$("#user_resource_form").form({url:ctxAdmin+"/sys/user/updateUserResource",onSubmit:function(d){$.messager.progress({title:"提示信息！",text:"数据处理中，请稍后...."});var b=$(this).form("validate");if(!b){$.messager.progress("close")}else{var a=$user_datagrid.datagrid("getSelections");var c=[];$.each(a,function(e,f){c.push(f.id)});d.userIds=c}return b},success:function(b){$.messager.progress("close");var a=$.parseJSON(b);if(a.code===1){$user_resource_dialog.dialog("destroy");$user_datagrid.datagrid("reload");$organ_tree.tree("reload");eu.showMsg(a.msg)}else{eu.showAlertMsg(a.msg,"error")}}})}function editUserResource(){var a=$user_datagrid.datagrid("getSelections");var b=$user_datagrid.datagrid("getSelected");if(b){if(!isOpeated(b.id)){eu.showMsg("超级管理员用户信息不允许被其他人修改！");return}if(b.id===1){eu.showMsg("超级管理员无需设置资源！");return}$user_resource_dialog=$("<div/>").dialog({title:"用户资源信息",top:20,width:500,height:360,modal:true,maximizable:true,href:ctxAdmin+"/sys/user/resource?id="+b.id,buttons:[{text:"保存",iconCls:"easyui-icon-save",handler:function(){$user_resource_form.submit()}},{text:"关闭",iconCls:"easyui-icon-cancel",handler:function(){$user_resource_dialog.dialog("destroy")}}],onClose:function(){$user_resource_dialog.dialog("destroy")},onLoad:function(){initUserResourceForm()}})}else{eu.showMsg("您未选择任何操作对象，请选择一行数据！")}}function initUserOrganForm(){$user_organ_form=$("#user_organ_form").form({url:ctxAdmin+"/sys/user/updateUserOrgan",onSubmit:function(d){$.messager.progress({title:"提示信息！",text:"数据处理中，请稍后...."});var b=$(this).form("validate");if(!b){$.messager.progress("close")}else{var a=$user_datagrid.datagrid("getSelections");var c=[];$.each(a,function(e,f){c.push(f.id)});d.userIds=c}return b},success:function(b){$.messager.progress("close");var a=$.parseJSON(b);if(a.code===1){$user_organ_dialog.dialog("destroy");$user_datagrid.datagrid("reload");$organ_tree.tree("reload");eu.showMsg(a.msg)}else{eu.showAlertMsg(a.msg,"error")}}})}function editUserOrgan(){var a=$user_datagrid.datagrid("getSelections");var c=$user_datagrid.datagrid("getSelected");if(c){if(!isOpeated(c.id)){eu.showMsg("超级管理员用户信息不允许被其他人修改！");return}var b=ctxAdmin+"/sys/user/organ";if(c.id&&a.length===1){b=b+"?id="+c.id}$user_organ_dialog=$("<div/>").dialog({title:"用户机构信息",top:20,width:500,height:200,modal:true,maximizable:true,href:b,buttons:[{text:"保存",iconCls:"easyui-icon-save",handler:function(){$user_organ_form.submit()}},{text:"关闭",iconCls:"easyui-icon-cancel",handler:function(){$user_organ_dialog.dialog("destroy")}}],onClose:function(){$user_organ_dialog.dialog("destroy")},onLoad:function(){initUserOrganForm()}})}else{eu.showMsg("您未选择任何操作对象，请选择一行数据！")}}function initUserPostForm(){$user_post_form=$("#user_post_form").form({url:ctxAdmin+"/sys/user/updateUserPost",onSubmit:function(d){$.messager.progress({title:"提示信息！",text:"数据处理中，请稍后...."});var b=$(this).form("validate");if(!b){$.messager.progress("close")}else{var a=$user_datagrid.datagrid("getSelections");var c=[];$.each(a,function(e,f){c.push(f.id)});d.userIds=c}return b},success:function(b){$.messager.progress("close");var a=$.parseJSON(b);if(a.code===1){$user_post_dialog.dialog("destroy");$user_datagrid.datagrid("reload");eu.showMsg(a.msg)}else{eu.showAlertMsg(a.msg,"error")}}})}function editUserPost(){var d=$user_datagrid.datagrid("getSelections");var e=$user_datagrid.datagrid("getSelected");if(e){var b=$organ_tree.tree("getSelected");if(d.length>1&&b==null){eu.showMsg("批量设置岗位，请选中左侧机构树中的一个机构！");return}var a="";if(b!=null){a="organId="+b.id}var c=ctxAdmin+"/sys/user/post";if(e.id){c=c+"?id="+e.id+"&"+a}else{c+="?"+a}$user_post_dialog=$("<div/>").dialog({title:"用户岗位信息",top:20,width:500,height:200,modal:true,maximizable:true,href:c,buttons:[{text:"保存",iconCls:"easyui-icon-save",handler:function(){$user_post_form.submit()}},{text:"关闭",iconCls:"easyui-icon-cancel",handler:function(){$user_post_dialog.dialog("destroy")}}],onClose:function(){$user_post_dialog.dialog("destroy")},onLoad:function(){initUserPostForm();if(d.length===1){$user_post_form.form("load",e)}}})}else{eu.showMsg("您未选择任何操作对象，请选择一行数据！")}}function del(){var a=$user_datagrid.datagrid("getSelections");if(a.length>0){$.messager.confirm("确认提示！","您确定要删除选中的所有行?",function(c){if(c){var b=[];$.each(a,function(d,e){b[d]=e.id});$.ajax({url:ctxAdmin+"/sys/user/remove",type:"post",data:{ids:b},traditional:true,dataType:"json",success:function(d){if(d.code===1){$user_datagrid.datagrid("load");eu.showMsg(d.msg)}else{eu.showAlertMsg(d.msg,"error")}}})}})}else{eu.showMsg("您未选择任何操作对象，请选择一行数据！")}}function move(b){var e=$user_datagrid.datagrid("getSelections");var f=$user_datagrid.datagrid("getSelected");if(f){if(e.length>1){f=e[e.length-1];eu.showMsg("您选择了多个操作对象，请选择一行数据！");return}var h=$user_datagrid.datagrid("getRowIndex",f);var a,g;$.messager.progress({title:"提示信息！",text:"数据处理中，请稍后...."});var d=$user_datagrid.datagrid("getData").rows;var c;if(b){c=true;a=f.id;if(h===0){}else{if(d.length>=(h+1)){g=d[h-1].id}}}else{c=false;g=f.id;if(d.length===(h+1)){}else{if(d.length>(h+1)){a=d[h+1].id}}}if(!a||!g){$.messager.progress("close");return false}$.ajax({url:ctxAdmin+"/sys/user/changeOrderNo",type:"post",data:{upUserId:a,downUserId:g,moveUp:c},dataType:"json",traditional:true,success:function(i){$.messager.progress("close");if(i.code===1){$user_datagrid.datagrid("reload")}else{eu.showAlertMsg(i.msg,"error")}}})}else{eu.showMsg("您未选择任何操作对象，请选择一行数据！")}}function lock(b){var c=$user_datagrid.datagrid("getSelections");var e=$user_datagrid.datagrid("getSelected");if(e){var d=[];$.each(c,function(f,g){d.push(g.id)});var a=3;if(!b){a=0}$.ajax({url:ctxAdmin+"/sys/user/lock",type:"post",data:{userIds:d,status:a},dataType:"json",traditional:true,success:function(f){$.messager.progress("close");if(f.code===1){$user_datagrid.datagrid("reload")}else{eu.showAlertMsg(f.msg,"error")}}})}else{eu.showMsg("您未选择任何操作对象，请选择一行数据！")}}function search(){var d=$organ_tree.tree("getSelected");var b="";if(d!=null){b=d.id}var a={};var c={organId:b};var e=$.serializeObject($user_search_form);a=$.extend(a,c,e);$user_datagrid.datagrid("load",a)};