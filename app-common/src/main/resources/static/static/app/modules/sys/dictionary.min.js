var $dictionary_tree;var $dictionary_dialog;var $dictionary_form;var $dictionaryItem_datagrid;var editRow=undefined;var editRowData=undefined;var $dictionaryItem_search_form;var currentDictionaryId=undefined;$(function(){$dictionaryItem_search_form=$("#dictionaryItem_search_form").form();loadDictionaryTree();dictionaryItemDatagrid()});function loadDictionaryTree(){$dictionary_tree=$("#dictionary_tree").tree({url:ctxAdmin+"/sys/dictionary/tree",formatter:function(a){return a.text},onClick:function(a){search()},onBeforeLoad:function(a,b){$("#dictionary_tree").html("数据加载中...")},onSelect:function(a){},onContextMenu:function(b,a){b.preventDefault();if(a.id!=undefined&&a.id!=""){$("#treeMenu").menu({onClick:function(c){if(c.name=="edit"){showDictionaryDialog(a.id)}else{if(c.name=="delete"){delDictionary(a.id,a.text)}}}}).menu("show",{left:b.pageX,top:b.pageY})}},onLoadSuccess:function(a,b){}})}function dictionaryItemDatagrid(){$dictionaryItem_datagrid=$("#dictionaryItem_datagrid").datagrid({url:ctxAdmin+"/sys/dictionaryItem/datagrid",fit:true,pagination:true,pagePosition:"bottom",fitColumns:false,striped:true,pageSize:20,singleSelect:false,rownumbers:true,checkbox:true,nowrap:true,border:false,idField:"id",frozenColumns:[[{field:"ck",checkbox:true,width:60},{field:"dictionaryId",title:"数据字典",width:150,formatter:function(b,a,c){return a.dictionaryName},editor:{type:"combobox",options:{url:ctxAdmin+"/sys/dictionary/comboboxGroup",required:true,missingMessage:"请选择字数据字典！",editable:false,groupField:"group",onSelect:function(a){currentDictionaryId=a.value;editRowData.dictionaryCode=a.data;var b=editRowData.dictionaryCode;initCodeAndValue(b)},onLoadSuccess:function(){var b=$(this).combobox("getData");currentDictionaryId=$(this).combobox("getValue");var a="";$.each(b,function(d,c){if(c.value==currentDictionaryId){a=c.data;return false}});if(editRowData==undefined||editRowData.id==undefined||editRowData.id==""){initCodeAndValue(a)}}}}},{field:"name",title:"名称",width:200,editor:{type:"textbox",options:{required:true,missingMessage:"请输入名称！",validType:["minLength[1]","length[1,64]","legalInput"]}}}]],columns:[[{field:"id",title:"主键",hidden:true,sortable:true,align:"right",width:80},{field:"parentId",title:"上级节点",width:200,formatter:function(b,a,c){return a.parentName},editor:{type:"combotree",options:{url:ctxAdmin+"/sys/dictionaryItem/combotree?selectType=select",onBeforeLoad:function(a,b){if(currentDictionaryId==undefined&&editRowData.dictionaryId!=""){currentDictionaryId=editRowData.dictionaryId}if(currentDictionaryId!=undefined){b["dictionary.id"]=currentDictionaryId}if(editRowData!=undefined){b.id=editRowData.id}}}}},{field:"code",title:"编码",width:200,sortable:true,editor:{type:"textbox",options:{required:true,missingMessage:"请输入编码！",validType:["minLength[1]","length[1,36]","legalInput"],onChange:function(c,b){var a=$dictionaryItem_datagrid.datagrid("getEditor",{index:editRow,field:"value"});$(a.target).textbox("setValue",c)}}}},{field:"value",title:"属性值",width:200,sortable:true,editor:{type:"textbox",options:{}}},{field:"remark",title:"备注",width:200,editor:{type:"textbox",options:{}}},{field:"orderNo",title:"排序",align:"right",width:60,sortable:true,editor:{type:"numberspinner",options:{required:true}}},{field:"operate",title:"操作",width:200,formatter:function(c,b,d){var a="";if(b.editing){a="<a class='easyui-linkbutton' data-options='iconCls:\"easyui-icon-save\"' onclick='saveDictionaryItem(this,"+d+',"'+b.id+"\")' >保存 </a>&nbsp;<a class='easyui-linkbutton' data-options='iconCls:\"easyui-icon-cancel\"' onclick='rejectChanges("+d+");' >取消  </a>"}else{a="<a class='easyui-linkbutton' data-options='iconCls:\"easyui-icon-edit\"' onclick='beginEdit("+d+")'>编辑</a>&nbsp;<a class='easyui-linkbutton' data-options='iconCls:\"easyui-icon-remove\"' onclick='delDictionaryItem(\""+b.id+'","'+b.name+"\")'>删除</a>"}return a}}]],toolbar:[{text:"新增",iconCls:"easyui-icon-add",handler:function(){addDictionaryItem()}},"-",{text:"删除",iconCls:"easyui-icon-remove",handler:function(){delDictionaryItem()}}],onBeforeEdit:function(a,b){editRow=a;editRowData=b;b.editing=true;updateActions(a);$.parser.parse($(".easyui-linkbutton").parent())},onAfterEdit:function(a,b){b.editing=false;updateActions(a);$.parser.parse($(".easyui-linkbutton").parent());editRow=undefined},onCancelEdit:function(a,b){b.editing=false;updateActions(a);$.parser.parse($(".easyui-linkbutton").parent());editRow=undefined},onLoadSuccess:function(a){$(this).datagrid("clearSelections");$(this).datagrid("clearChecked");$(this).datagrid("unselectAll");editRow=undefined},onRowContextMenu:function(b,c,a){b.preventDefault()}}).datagrid("showTooltip")}function initCodeAndValue(b){var d=$dictionaryItem_datagrid.datagrid("getEditor",{index:editRow,field:"parentId"});$(d.target).combotree("clear").combotree("reload");var c=$dictionaryItem_datagrid.datagrid("getEditor",{index:editRow,field:"code"});var a=$dictionaryItem_datagrid.datagrid("getEditor",{index:editRow,field:"value"});$(c.target).textbox("setValue",b+"_");$(a.target).textbox("setValue",b+"_")}function addDictionaryItem(){if(editRow!=undefined){eu.showMsg("请先保存正在编辑的数据！");return false}else{$dictionaryItem_datagrid.datagrid("unselectAll");var b=$dictionary_tree.tree("getSelected");var a="";if(b!=null&&b.attributes["groupId"]!=null){a=b.id}var c={id:"",dictionaryId:a,editing:true};$dictionaryItem_datagrid.datagrid("appendRow",c);editRow=$dictionaryItem_datagrid.datagrid("getRows").length-1;$dictionaryItem_datagrid.datagrid("selectRow",editRow);beginEdit(editRow);var e=$dictionaryItem_datagrid.datagrid("getRowIndex",c);var d=$dictionaryItem_datagrid.datagrid("getEditor",{index:e,field:"orderNo"});setDictionaryItemSortValue(d.target)}}function updateActions(a){$dictionaryItem_datagrid.datagrid("updateRow",{index:a,row:{}});$dictionaryItem_datagrid.datagrid("refreshRow",a)}function beginEdit(a){$dictionaryItem_datagrid.datagrid("beginEdit",a)}function rejectChanges(a){$dictionaryItem_datagrid.datagrid("endEdit",a);$dictionaryItem_datagrid.datagrid("rejectChanges",a)}function saveDictionaryItem(e,b,f){$dictionaryItem_datagrid.datagrid("unselectAll");$dictionaryItem_datagrid.datagrid("selectRow",b);$dictionaryItem_datagrid.datagrid("endEdit",b);var a=$dictionaryItem_datagrid.datagrid("getSelected");var d=$dictionaryItem_datagrid.datagrid("validateRow",b);if(!d){var c=$dictionaryItem_datagrid.datagrid("getEditor",{index:b,field:"name"});$(c.target).focus();return false}$.ajax({type:"POST",url:ctxAdmin+"/sys/dictionaryItem/save",data:$.extend({id:a.id},a),traditional:true,dataType:"json",success:function(h){if(h.code==1){$dictionaryItem_datagrid.datagrid("reload");eu.showMsg(h.msg)}else{if(h.code==2){eu.showMsg(h.msg);var g=$dictionaryItem_datagrid.datagrid("getEditor",{index:b,field:h.obj});if(g!=undefined){$(g.target).focus()}beginEdit(b)}else{eu.showAlertMsg(h.msg);rejectChanges(b)}}}})}function dictionaryFormInit(){$dictionary_form=$("#dictionary_form").form({url:ctxAdmin+"/sys/dictionary/save",onSubmit:function(b){$.messager.progress({title:"提示信息！",text:"数据处理中，请稍后...."});var a=$(this).form("validate");if(!a){$.messager.progress("close")}return a},success:function(b){$.messager.progress("close");var a=$.parseJSON(b);if(a.code==1){$dictionary_dialog.dialog("destroy");$dictionary_tree.tree("reload");eu.showMsg(a.msg)}else{if(a.code==2){$.messager.alert("提示信息！",a.msg,"warning",function(){if(a.obj){$('#dictionary_form input[name="'+a.obj+'"]').focus()}})}else{eu.showAlertMsg(a.msg,"error")}}},onLoadSuccess:function(a){}})}function showDictionaryDialog(a){var b=ctxAdmin+"/sys/dictionary/input";if(a!=undefined){b+="?id="+a}$dictionary_dialog=$("<div/>").dialog({title:"字典详细信息",top:20,width:500,height:360,modal:true,maximizable:true,href:b,buttons:[{text:"保存",iconCls:"easyui-icon-save",handler:function(){$dictionary_form.submit()}},{text:"关闭",iconCls:"easyui-icon-cancel",handler:function(){$dictionary_dialog.dialog("destroy")}}],onClose:function(){$dictionary_dialog.dialog("destroy")},onLoad:function(){dictionaryFormInit()}})}function setDictionaryItemSortValue(a){$.get(ctxAdmin+"/sys/dictionaryItem/maxSort",function(b){if(b.code==1){$(a).numberbox({value:b.obj+30});$(a).numberbox("validate")}},"json")}function delDictionary(a,b){$.messager.confirm("确认提示！","您确定要删除["+b+"]？",function(d){if(d){var c=new Array();c.push(a);$.ajax({url:ctxAdmin+"/sys/dictionary/remove",type:"post",data:{ids:c},dataType:"json",traditional:true,success:function(e){if(e.code==1){$dictionaryItem_datagrid.datagrid("reload");$dictionary_tree.tree("reload");eu.showMsg(e.msg)}else{eu.showAlertMsg(e.msg,"error")}}})}})}function delDictionaryItem(d,a){var b=$dictionaryItem_datagrid.datagrid("getChecked");if(d!=undefined||b.length>0){var c="您确定要删除";if(a!=undefined){c+="字典项["+a+"]?"}else{c+="选中的所有字典项?"}$.messager.confirm("确认提示！",c,function(f){if(f){var e=new Array();$.messager.progress({title:"提示信息！",text:"数据处理中，请稍后...."});if(d!=undefined){e.push(d)}else{$.each(b,function(g,h){e.push(h.id)})}$.ajax({url:ctxAdmin+"/sys/dictionaryItem/remove",type:"post",data:{ids:e},dataType:"json",traditional:true,success:function(g){$.messager.progress("close");if(g.code==1){$dictionaryItem_datagrid.datagrid("clearSelections");$dictionaryItem_datagrid.datagrid("load");eu.showMsg(g.msg)}else{eu.showAlertMsg(g.msg,"error")}}})}})}else{eu.showMsg("请选择要操作的对象！")}}function search(){var d=$dictionary_tree.tree("getSelected");var c="";if(d!=null){c=d.id}var a={};var b={"dictionary.id":c};var e={name:$("#name_OR_code").val(),code:$("#name_OR_code").val()};a=$.extend(a,b,e);$dictionaryItem_datagrid.datagrid("load",a)};